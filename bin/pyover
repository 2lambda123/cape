#!/usr/bin/env python

# Import the full module
import pyOver
# Automated report generation
import pyOver.report
# Input parsing
from cape.argread import readflagstar

# Import docstring (makes the docstring available to module import)
import pf_doc
__doc__ = pf_doc.__doc__
    
# Check if run as a script.
if __name__ == "__main__":
    # Parse inputs.
    a, kw = readflagstar(pyOver.os.sys.argv)
    
    # Check for a help flag.
    if kw.get('h') or kw.get('help'):
        print(__doc__)
        pyOver.os.sys.exit()
    
    # Get constraints and convert text to list.
    cons  = kw.get('cons',        '').split(',')
    cons += kw.get('constraints', '').split(',')
    # Set the constraints back into the keywords.
    kw['cons'] = [con.strip() for con in cons]
        
    # Get file name.
    fname = kw.get('f', 'pyOver.json')
    
    # Try to read it.
    ofl = pyOver.Overflow(fname)
    
    # Process index list.
    if ('I' in kw) and (kw['I'] != True):
        # Turn into a single list
        kw['I'] = ofl.x.ExpandIndices(kw['I'])
        
    # Process inputs.
    if kw.get('c'):
        # Display status.
        ofl.DisplayStatus(**kw)
    elif kw.get('batch'):
        # Process a batch job
        ofl.SubmitBatchPBS(pyOver.os.sys.argv)
    elif kw.get('extend'):
        # Extend the number of iterations in a phase
        ofl.ExtendCases(**kw)
    elif kw.get('apply'):
        # Rewrite namelists and possibly add phases
        ofl.ApplyCases(**kw)
    elif kw.get('aero'):
        # Check for component.
        if kw['aero'] != True:
            # Process requested component
            kw['comp'] = kw['aero']
        # Collect force and moment data.
        ofl.Aero(**kw)
    elif kw.get('archive'):
        # Archive cases
        ofl.ArchiveCases(**kw)
    elif kw.get('report'):
        # Get the report(s) to create.
        if kw['report'] == True:
            # All reports
            reps = [ofl.opts.get_ReportList()[0]]
        else:
            # User-specified report
            reps = [kw['report']]
        # Loop through reports.
        for rep in reps:
            # Get the report.
            R = pyOver.report.Report(ofl, rep)
            # Update according to other options
            R.UpdateReport(**kw)
    else:
        # Do it.
        ofl.SubmitJobs(**kw)
    
