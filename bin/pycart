#!/usr/bin/env python

# Import the full module
import pyCart
# Automated report generation
import pyCart.report
# Input parsing
from pyCart.argread import readflagstar

# Import docstring (makes the docstring available to module import)
import pc_doc
__doc__ = pc_doc.__doc__
    
# Check if run as a script.
if __name__ == "__main__":
    # Parse inputs.
    a, kw = readflagstar(pyCart.os.sys.argv)
    
    # Check for a help flag.
    if kw.get('h') or kw.get('help'):
        print(__doc__)
        pyCart.os.sys.exit()
    
    # Get constraints and convert text to list.
    cons  = kw.get('cons',        '').split(',')
    cons += kw.get('constraints', '').split(',')
    # Set the constraints back into the keywords.
    kw['cons'] = [con.strip() for con in cons]
        
    # Get file name.
    fname = kw.get('f', 'pyCart.json')
    
    # Try to read it.
    cart3d = pyCart.Cart3d(fname)
    
    # Process index list.
    if ('I' in kw) and (kw['I'] != True):
        # Turn into a single list
        kw['I'] = cart3d.x.ExpandIndices(kw['I'])
        
    # Process inputs.
    if kw.get('c'):
        # Display status.
        cart3d.DisplayStatus(**kw)
    elif kw.get('aero'):
        # Check for component.
        if kw['aero'] != True:
            # Process requested component
            kw['comp'] = kw['aero']
        # Collect force and moment data.
        cart3d.Aero(**kw)
    elif kw.get('pt'):
        # Update point sensor(s) data book
        cart3d.UpdatePointSensor(**kw)
    elif kw.get('a'):
        # Archive folders
        cart3d.TarAdapt(**kw)
        cart3d.TarViz(**kw)
    elif kw.get('expand'):
        # Archive folders
        cart3d.UntarAdapt(**kw)
    elif kw.get('archive'):
        # Archive cases
        cart3d.ArchiveCases(**kw)
    elif kw.get('apply'):
        # Apply JSON settings
        cart3d.ApplyFlowCartSettings(**kw)
    elif kw.get('explode'):
        # Break out each named component.
        cart3d.ExplodeTri()
    elif kw.get('report'):
        # Get the report(s) to create.
        if kw['report'] == True:
            # All reports
            reps = [cart3d.opts.get_ReportList()[0]]
        else:
            # User-specified report
            reps = [kw['report']]
        # Loop through reports.
        for rep in reps:
            # Get the report.
            R = pyCart.report.Report(cart3d, rep)
            # Update according to other options
            R.UpdateReport(**kw)
    else:
        # Do it.
        cart3d.SubmitJobs(**kw)
    
